<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thai Vision - 100% Local AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Local OCR Engine -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #000;
            margin: 0; padding: 0;
            overflow: hidden; height: 100vh; width: 100vw;
            touch-action: manipulation;
        }
        .app-container { position: fixed; inset: 0; display: flex; flex-direction: column; }
        video, #freezeFrame { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 10; }
        
        #resultsSheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px 24px 0 0;
            z-index: 50;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 75vh;
            display: flex; flex-direction: column;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.8);
        }
        #resultsSheet.open { transform: translateY(0); }

        .results-list { overflow-y: auto; padding: 0 20px 40px 20px; flex-grow: 1; }
        .result-item { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 16px; margin-bottom: 12px; }

        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #3b82f6; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #permissionOverlay { position: fixed; inset: 0; background: #0f172a; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; text-align: center; }
    </style>
</head>
<body class="text-white">

    <div id="permissionOverlay">
        <div class="mb-6 bg-blue-500/10 p-6 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
            </svg>
        </div>
        <h2 class="text-xl font-bold mb-2">Local Thai Vision</h2>
        <p class="text-slate-400 text-sm mb-8">No Internet Required. 100% Private.</p>
        <button id="startBtn" class="bg-blue-600 w-full py-4 rounded-full font-bold shadow-lg active:scale-95 transition-transform mb-4">START ENGINE</button>
        <p id="initStatus" class="text-[10px] text-slate-500 uppercase tracking-widest font-bold"></p>
    </div>

    <div class="app-container">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="freezeFrame" class="hidden"></canvas>
        <div id="status" class="fixed inset-0 z-30 bg-black/50 backdrop-blur-md hidden flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <span id="statusText" class="text-sm font-bold tracking-[0.2em] text-blue-400 uppercase">Thinking...</span>
            <span id="progressText" class="text-[10px] text-slate-400 mt-2">Loading local brain (first time only)</span>
        </div>

        <div id="mainControls" class="fixed bottom-12 left-0 right-0 flex justify-center items-center z-40 px-6">
            <button id="snapBtn" class="bg-white text-black h-20 w-20 rounded-full flex items-center justify-center shadow-2xl active:scale-90 transition-transform ring-4 ring-white/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2-2H5a2 2 0 01-2-2V9z" />
                </svg>
            </button>
        </div>

        <div id="resultsSheet">
            <div class="sheet-handle"></div>
            <div class="px-5 pb-4 flex justify-between items-center border-b border-white/10">
                <h2 class="text-lg font-bold text-blue-400">Local Translation</h2>
                <button id="closeSheet" class="text-[10px] font-black uppercase tracking-widest text-slate-400 py-2 px-5 bg-white/5 rounded-full border border-white/10">Close</button>
            </div>
            <div id="resultsList" class="results-list mt-4"></div>
        </div>
    </div>

    <script type="module">
        // Import local translation brain
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

        const video = document.getElementById('video');
        const freezeFrame = document.getElementById('freezeFrame');
        const snapBtn = document.getElementById('snapBtn');
        const startBtn = document.getElementById('startBtn');
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const progressText = document.getElementById('progressText');
        const resultsSheet = document.getElementById('resultsSheet');
        const resultsList = document.getElementById('resultsList');
        const closeSheet = document.getElementById('closeSheet');
        const permissionOverlay = document.getElementById('permissionOverlay');
        const initStatus = document.getElementById('initStatus');

        let translator = null;
        let isFrozen = false;

        async function initAI() {
            try {
                initStatus.textContent = "Waking up camera...";
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" },
                    audio: false
                });
                video.srcObject = stream;
                
                initStatus.textContent = "Loading translation brain...";
                // Load small, efficient local translation model
                translator = await pipeline('translation', 'Xenova/t5-small', {
                    progress_callback: (data) => {
                        if (data.status === 'progress') {
                            initStatus.textContent = `Downloading AI: ${Math.round(data.progress)}%`;
                        }
                    }
                });

                permissionOverlay.style.display = 'none';
            } catch (err) {
                initStatus.textContent = "Error: " + err.message;
            }
        }

        async function processFrame() {
            if (!translator || isFrozen) return;

            // 1. Capture
            freezeFrame.width = video.videoWidth;
            freezeFrame.height = video.videoHeight;
            const ctx = freezeFrame.getContext('2d');
            ctx.drawImage(video, 0, 0);

            isFrozen = true;
            video.style.opacity = "0";
            freezeFrame.classList.remove('hidden');
            statusDiv.classList.remove('hidden');
            statusDiv.classList.add('flex');
            statusText.textContent = "OCR Reading...";

            try {
                // 2. Local OCR (Tesseract)
                const { data: { text, blocks } } = await Tesseract.recognize(freezeFrame, 'eng', {
                    logger: m => { if(m.status === 'recognizing text') statusText.textContent = `OCR: ${Math.round(m.progress * 100)}%` }
                });

                if (!text.trim()) {
                    alert("No text found.");
                    resetCamera();
                    return;
                }

                statusText.textContent = "Translating...";
                resultsList.innerHTML = '';

                // 3. Local Translation (Transformers.js)
                // We split by lines to give better results
                const lines = text.split('\n').filter(l => l.trim().length > 3);
                
                for (const line of lines) {
                    const result = await translator(line, {
                        src_lang: 'eng',
                        tgt_lang: 'tha', // Note: T5 models usually use task prefixes
                    });

                    const thaiText = result[0].translation_text;
                    // Simple Phonetic logic (Mocking since T5-small doesn't do phonetic romanization natively)
                    // For a true local phonetic, you'd need another small model or mapping.
                    const phonetic = line.toUpperCase(); 

                    const div = document.createElement('div');
                    div.className = 'result-item';
                    div.innerHTML = `
                        <div class="flex flex-col gap-1">
                            <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Original: ${line}</span>
                            <span class="text-sm font-black text-yellow-400 tracking-wide uppercase">Pronounce: ${phonetic}</span>
                            <div class="h-[1px] bg-white/10 my-1"></div>
                            <span class="text-xl font-medium text-white">${thaiText}</span>
                        </div>
                    `;
                    resultsList.appendChild(div);
                }

                resultsSheet.classList.add('open');
            } catch (err) {
                alert("Processing failed: " + err.message);
                resetCamera();
            } finally {
                statusDiv.classList.add('hidden');
            }
        }

        function resetCamera() {
            isFrozen = false;
            video.style.opacity = "1";
            freezeFrame.classList.add('hidden');
            resultsSheet.classList.remove('open');
            statusDiv.classList.add('hidden');
        }

        startBtn.onclick = initAI;
        snapBtn.onclick = processFrame;
        closeSheet.onclick = resetCamera;
    </script>
</body>
</html>